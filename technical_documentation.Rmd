---
title: "User Manual/Technical Documentation"
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Entry Application

## Access

## Entering Data

## Updating Data Entry

### Adding or removing sites

### Adding a category

# Troubleshooting

authenitcation

```{r, eval = FALSE}
# auto-authenticate google sheets ... this will have you interactively authenticate using broswer
 options(gargle_oauth_cache = ".secrets/")
## auto authenticate without browser
  gs4_auth(
  cache = ".secrets",
  email = "email@gmail.com" # email for authenitcation
  )
```

```{r, eval = FALSE}
drive_auth(cache = ".secrets",
           email = "email@gmail.com") #email for authentication
```

# file access

```{r, eval = FALSE}
#read in all the data
#url to the folder that contains the data set google sheet
folder_url <- "https://drive.google.com/drive/u/0/folders/11jjznh0MFuhy8oLxHp8uGePF4xR5T-GW"

files <- drive_ls(folder_url) |>
  filter(name == "compiled_mps") #name of data set file 
#save the file id
main_sheet_id <- as_id(files)
#read in the data set
main_sheet <- read_sheet(main_sheet_id) |> 
  mutate(year = as.numeric(year))
```

# Updating categories

```{r, eval = FALSE}
 
    # Consistent Funding tabItem----
    tabItem(
      #update to the name of the tab, must match tabname in lookup table
      tabName = "funding",
      fluidRow(
        #update this with the actual name of the category
        h1("Consistent Funding", align = "center"),
        br()
      ),
      
      #update this to say ui_tabname
      uiOutput("ui_funding"),

      # start third fluid row
      
      #update the previous and next button number to one higher than the following numbers if this is the first time a new category is being added. Otherwise the number must be one higher than the highest previous and next button in the application
      fluidRow(
        column(10, actionButton("prev_4", "Previous", class = "btn-primary", style="color: #FFFFFF; background-color: #094074")),
        column(2, align = "right", actionButton("next_6", "Save and Continue", class = "btn-primary", style="color: #FFFFFF; background-color: #094074")),
      ) # end fourth fluid row
    ), # end consistent funding tab item
```

# updating the server code 

```{r, eval = FALSE}

#start consistent funding tab actions ----
  #consistent funding tab data entry
  
  #start consistent funding data entry

  #replace with the name of the following tab, this will likely remain as summary if you are placing the new tab last
  observe(
    if (entry_con() && input$tabs == "summary") {
      
      # read in the google sheet
      # need to do this each time we write in case multiple people are on the app
      # identify the url
      # also read in for checking for existing data
      main_sheet <- read_sheet(main_sheet_id) |> 
        mutate(year = as.numeric(year))
      
      #replace all instances of con with the three letter code for the subcategory
      con_lookuptable <- main_lookuptable |> 
        filter(tab == "funding") #change to the name of the tab, must match ui and lookup table
      
      #initialize blank data frame
      append_data <- tibble()
      
      for (i in seq_along(con_lookuptable$subcategory)) {
        # name of the subcategory
        con_sub_category_name <- con_lookuptable$subcategory[i]
        
        # get the name of the score id
        con_score_input <- con_lookuptable$score_id[i]
        
        # get the value of the score
        con_score_value <- input[[con_score_input]]
        
        # name of comment id
        con_comment_input <- con_lookuptable$comment_id[i]
        
        # get the value of the comment
        con_comment_value <- input[[con_comment_input]]
        
        
        #replace th category value with the full name of the category (what you want to appear in the data)
        con_row <- data_entry_function(google_instance = main_sheet_id, google_data = main_sheet, year_entered = input$year_input, category = "Consistent Funding", sub_category_entered = con_sub_category_name, indicator_type = "Process Indicator", score = con_score_value, country = input$country_input, site_entered = input$site_input, comments_entered = con_comment_value, evaluator = input$name_input)
        if (!is.null(nrow(con_row))){
          append_data <- bind_rows(con_row, append_data) 
          
        }
        
      }
      if (nrow(append_data) >0){
        sheet_append(main_sheet_id, data = append_data) }
      entry_con(FALSE)
    }
  ) 
  

  entry_con <- reactiveVal(FALSE)
  # consistent funding tab previous button
  #change to one higher than the highest number previous button, needs to match ui previous button
  observeEvent(input$prev_4, {
    newtab <- switch(input$tabs,
                     "community" = "funding",
                     "funding" = "community")
    updateTabItems(session, "tabs", newtab)
  }) # end consistent funding tab previous button
  
   # consistent funding next button
  observeEvent(input$next_6, {
    newtab <- switch(input$tabs,
                     "funding" = "summary",
                     "data" = "summary")  
    # change to the last tab
    updateTabItems(session, "tabs", newtab)
    entry_con(TRUE)
  })
  
  
# end consistent funding tab actions
  
```
